<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Seller Orders — FarmToHome</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="/styles.css">
</head>
<body>
  <main class="container py-4">
    <div class="d-flex justify-content-between align-items-center mb-3">
      <h3>Orders</h3>
      <a href="/seller-login.html" class="btn btn-light">Logout</a>
    </div>
    <div id="ordersList"></div>
  </main>

  <script>
    // require seller login
    if(!localStorage.getItem('fth_seller')){ location.href = '/seller-login.html'; }

    async function loadOrders(){
      try{
        const res = await fetch('/api/orders', { headers: { 'X-Seller-Id':'FTH', 'X-Seller-Secret':'FTH12345' } });
        const orders = await res.json();
        const out = document.getElementById('ordersList'); out.innerHTML = '';
        if(!orders.length) return out.innerHTML = '<div class="p-4 text-muted">No orders yet</div>';
        orders.forEach(o=>{
          const div = document.createElement('div'); div.className='card mb-3';
          div.innerHTML = `
            <div class="card-body">
              <div class="d-flex justify-content-between align-items-start">
                <div>
                  <h5>Order #${o._id.slice(-6)}</h5>
                  <div class="small text-muted">${new Date(o.createdAt).toLocaleString()}</div>
                </div>
                <div>
                  <select class="form-select form-select-sm status-select" data-id="${o._id}">
                    <option value="pending">Pending</option>
                    <option value="paid">Paid</option>
                    <option value="accepted">Accepted</option>
                    <option value="shipped">Shipped</option>
                    <option value="delivered">Delivered</option>
                    <option value="cancelled">Cancelled</option>
                  </select>
                </div>
              </div>
              <div class="mt-3">
                ${o.items.map(it=>`<div class="d-flex justify-content-between"><div>${it.product?.name||'Product'} × ${it.qty}</div><div>₹${(it.price*it.qty).toFixed(2)}</div></div>`).join('')}
              </div>
              <div class="mt-3 d-flex justify-content-between align-items-center">
                <div class="small text-muted">Deliver to: ${o.address ? (o.address.address + ', ' + o.address.city) : 'N/A'}</div>
                <div><strong>₹${o.total.toFixed(2)}</strong></div>
              </div>
              <div class="mt-3 text-end">
                <button class="btn btn-sm btn-primary update-status" data-id="${o._id}">Update</button>
              </div>
            </div>
          `;
          out.appendChild(div);
        });
        // set current statuses
        document.querySelectorAll('.status-select').forEach(s=>{
          const id = s.dataset.id; const order = orders.find(x=>x._id===id); if(order) s.value = order.status || 'pending';
        });
        // attach update handlers
        document.querySelectorAll('.update-status').forEach(btn=> btn.addEventListener('click', async (e)=>{
          const id = btn.dataset.id; const sel = document.querySelector(`.status-select[data-id="${id}"]`);
          const status = sel.value;
          try{
            const res = await fetch(`/api/orders/${id}/status`, { method: 'PUT', headers: { 'Content-Type':'application/json', 'X-Seller-Id':'FTH', 'X-Seller-Secret':'FTH12345' }, body: JSON.stringify({ status }) });
            const j = await res.json();
            if(!res.ok) return alert(j.message || 'Failed');
            alert('Updated'); loadOrders();
          }catch(err){ console.error(err); alert('Network error'); }
        }));
      }catch(err){ console.error(err); document.getElementById('ordersList').innerHTML = '<div class="p-4 text-danger">Failed to load orders</div>'; }
    }

    loadOrders();
  </script>
</body>
</html>