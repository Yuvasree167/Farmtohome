<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Checkout — FarmToHome</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="/styles.css">
  <style>
    .checkout-container {
      max-width: 1000px;
      margin: 0 auto;
    }
    .cart-item {
      padding: 1rem;
      border-bottom: 1px solid #eee;
    }
    .cart-item:last-child {
      border-bottom: none;
    }
    .item-image {
      width: 80px;
      height: 80px;
      object-fit: cover;
      border-radius: 8px;
    }
    .qty-control {
      width: 120px;
    }
    .qty-control .btn {
      padding: 0.25rem 0.5rem;
    }
    .qty-control .form-control {
      text-align: center;
    }
    .checkout-summary {
      position: sticky;
      top: 1rem;
    }
    .success-overlay {
      position: fixed;
      inset: 0;
      display: flex;
      align-items: center;
      justify-content: center;
      background: rgba(0,0,0,0.85);
      color: #fff;
      font-size: 1.2rem;
      opacity: 0;
      pointer-events: none;
      transition: opacity .36s;
      z-index: 1000;
    }
    .success-overlay.show {
      opacity: 1;
      pointer-events: auto;
    }
    .delivery-address {
      background: #f8f9fa;
      border-radius: 8px;
      padding: 1rem;
      margin-bottom: 1rem;
    }
  </style>
</head>
<body>
  <main class="container py-4">
    <div class="checkout-container">
      <div class="row g-4">
        <!-- Cart Items Column -->
        <div class="col-lg-8">
          <h4 class="mb-4">Review Your Cart</h4>
          <div id="cartItems" class="card">
            <div class="card-body">
              <!-- Cart items will be loaded here -->
            </div>
          </div>
        </div>

        <!-- Summary Column -->
        <div class="col-lg-4">
          <div class="checkout-summary card">
            <div class="card-body">
              <h5 class="card-title">Order Summary</h5>
              
              <div id="checkoutAddress" class="delivery-address mb-3">
                <!-- Address will be loaded here -->
              </div>

              <div id="summary" class="mb-4">
                <!-- Summary will be loaded here -->
              </div>

              <div class="d-grid gap-2">
                <button id="openPayment" class="btn btn-success btn-lg">Proceed to Payment</button>
                <a href="/" class="btn btn-outline-secondary">Continue Shopping</a>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </main>

  <div id="success" class="success-overlay">
    <div class="text-center">
      <div style="font-size:64px">✅</div>
      <div class="mt-3 h4">Payment Successful!</div>
      <div class="text-muted">Redirecting to home...</div>
    </div>
  </div>

  <script>
    const apiOrders = '/api/orders';

    function getCart(){ return JSON.parse(localStorage.getItem('ft_cart')||'[]'); }
    function setCart(c){ localStorage.setItem('ft_cart', JSON.stringify(c)); }

    async function loadSummary(){
      const cart = getCart();
      if(!cart.length){ 
        document.getElementById('cartItems').innerHTML = '<div class="p-4 text-center text-muted">Your cart is empty</div>';
        document.getElementById('summary').innerHTML = '<div class="text-center text-muted">No items in cart</div>';
        document.getElementById('openPayment').disabled = true;
        return;
      }

      const products = await fetch('/api/products').then(r=>r.json());
      let cartHtml = '';
      let summaryHtml = '';
      let total = 0;

      cart.forEach(it => {
        const p = products.find(x=>x._id===it.product);
        if(!p) return;
        
        const itemTotal = p.price * it.qty;
        total += itemTotal;

        // Cart item with quantity controls
        cartHtml += `
          <div class="cart-item" data-product-id="${p._id}">
            <div class="row align-items-center">
              <div class="col-auto">
                <img src="${p.image}" alt="${p.name}" class="item-image">
              </div>
              <div class="col">
                <h6 class="mb-1">${p.name}</h6>
                <div class="text-muted small">${p.description || ''}</div>
                <div class="text-success mt-1">₹${p.price.toFixed(2)}</div>
              </div>
              <div class="col-auto">
                <div class="qty-control input-group input-group-sm">
                  <button class="btn btn-outline-secondary remove-qty" data-id="${p._id}">−</button>
                  <input type="text" class="form-control" value="${it.qty}" readonly>
                  <button class="btn btn-outline-secondary add-qty" data-id="${p._id}">+</button>
                </div>
              </div>
              <div class="col-auto text-end">
                <div class="h6 mb-0">₹${itemTotal.toFixed(2)}</div>
              </div>
            </div>
          </div>
        `;

        // Summary line item
        summaryHtml += `
          <div class="d-flex justify-content-between mb-2">
            <div>${p.name} <span class="text-muted">× ${it.qty}</span></div>
            <div>₹${itemTotal.toFixed(2)}</div>
          </div>
        `;
      });

      // Add total to summary
      summaryHtml += `
        <hr>
        <div class="d-flex justify-content-between align-items-center mb-2">
          <div class="text-muted">Subtotal</div>
          <div>₹${total.toFixed(2)}</div>
        </div>
        <div class="d-flex justify-content-between align-items-center">
          <div class="h5 mb-0">Total</div>
          <div class="h5 mb-0 text-success">₹${total.toFixed(2)}</div>
        </div>
      `;

      document.getElementById('cartItems').innerHTML = cartHtml;
      document.getElementById('summary').innerHTML = summaryHtml;

      // Attach quantity control listeners
      document.querySelectorAll('.add-qty').forEach(btn => {
        btn.addEventListener('click', () => updateQuantity(btn.dataset.id, 1));
      });
      document.querySelectorAll('.remove-qty').forEach(btn => {
        btn.addEventListener('click', () => updateQuantity(btn.dataset.id, -1));
      });
    }

    // Update quantity of an item
    async function updateQuantity(productId, change) {
      const cart = getCart();
      const item = cart.find(i => i.product === productId);
      if (item) {
        item.qty += change;
        if (item.qty <= 0) {
          cart.splice(cart.indexOf(item), 1);
        }
      }
      setCart(cart);
      await loadSummary();
    }

    document.getElementById('openPayment').addEventListener('click', async ()=>{
      const total = await calcTotal();
      if (total <= 0) {
        alert('Please add items to your cart before proceeding to payment');
        return;
      }

      // Open payment tester in iPhone-style window
      const tester = window.open(`/tester.html?amount=${total.toFixed(2)}`, 'payment_tester', 
        'width=450,height=800,menubar=no,toolbar=no,location=no,status=no');

      // Listen for approval message (only once)
      function onMessage(event){
        if(event.data && event.data.type === 'payment_approved'){
          window.removeEventListener('message', onMessage);
          // create order via API
          createOrderAfterPayment();
        }
      }
      window.addEventListener('message', onMessage);
    });

    async function createOrderAfterPayment(){
      const token = localStorage.getItem('ft_token');
      const cart = getCart();
      // include selected address if available in order payload
      let address = null;
      try{
        const me = await fetch('/api/auth/me', { headers: { 'Authorization': `Bearer ${localStorage.getItem('ft_token')}` } }).then(r=>r.json());
        if(me && me.addresses){ address = me.addresses.find(a=>a.isDefault) || me.addresses[0] || null; }
      }catch(e){ /* ignore */ }
      try{
        const body = { items: cart };
        if(address) body.address = address;
        const res = await fetch(apiOrders, {method:'POST', headers:{'Content-Type':'application/json', 'Authorization': token?`Bearer ${token}`:''}, body: JSON.stringify(body)});
        const j = await res.json();
        console.log('order result', j);
      }catch(err){ console.error(err); }
      // show success overlay briefly then clear cart and redirect
      const success = document.getElementById('success');
      success.classList.add('show');
      setTimeout(()=>{ setCart([]); location.href = '/'; }, 1400);
    }

    async function calcTotal(){ const cart = getCart(); if(!cart.length) return 0; const products = await fetch('/api/products').then(r=>r.json()); let t=0; cart.forEach(it=>{ const p=products.find(x=>x._id===it.product); if(p) t+=p.price*it.qty; }); return t; }

    loadSummary();
    // load address linked to account
    async function loadAccountAddress(){
      try{
        const token = localStorage.getItem('ft_token');
        if(!token) {
          document.getElementById('checkoutAddress').innerHTML = `
            <div class="text-center">
              <div class="text-muted mb-2">Please sign in to continue checkout</div>
              <a href="/login.html" class="btn btn-outline-success btn-sm">Sign In</a>
            </div>`;
          document.getElementById('openPayment').disabled = true;
          return;
        }
        const me = await fetch('/api/auth/me', { headers: { 'Authorization': `Bearer ${token}` } }).then(r=>r.json());
        if(me && me.addresses && me.addresses.length){
          const a = me.addresses.find(x=>x.isDefault) || me.addresses[0];
          document.getElementById('checkoutAddress').innerHTML = `
            <h6 class="mb-3">Delivery Address</h6>
            <div class="d-flex justify-content-between align-items-start">
              <div>
                <div class="fw-bold">${a.label || 'Home'}</div>
                <div>${a.address}</div>
                <div>${a.city}, ${a.state} ${a.pincode}</div>
                <div class="small text-muted mt-1">Phone: ${a.phone || 'Not provided'}</div>
              </div>
              <a href="/account.html" class="btn btn-outline-secondary btn-sm">Change</a>
            </div>
          `;
        } else {
          document.getElementById('checkoutAddress').innerHTML = `
            <div class="text-center">
              <div class="text-muted mb-2">Please add a delivery address</div>
              <a href="/account.html" class="btn btn-outline-success btn-sm">Add Address</a>
            </div>`;
          document.getElementById('openPayment').disabled = true;
        }
      }catch(err){ console.error(err); }
    }

    loadAccountAddress();
  </script>
</body>
</html>
