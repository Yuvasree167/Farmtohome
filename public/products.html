<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Products — FarmToHome</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="/styles.css">
  <style>
    .filters { gap: 8px; }
    .product-card { height:100%; }
  </style>
</head>
<body>
  <nav class="navbar navbar-expand-lg navbar-light bg-light">
    <div class="container">
      <a class="navbar-brand" href="/">FarmToHome</a>
      <div class="d-flex">
        <a href="/" class="btn btn-outline-secondary me-2">Home</a>
        <a href="/list-product.html" class="btn btn-success">Sell / List product</a>
      </div>
    </div>
  </nav>

  <main class="container py-4">
    <div class="d-flex justify-content-between align-items-center mb-3">
      <h3>All Products</h3>
      <div class="d-flex filters">
        <input id="searchInput" class="form-control" placeholder="Search products..." style="min-width:220px">
        <select id="sortSelect" class="form-select">
          <option value="newest">Newest</option>
          <option value="price_asc">Price: Low to High</option>
          <option value="price_desc">Price: High to Low</option>
        </select>
        <select id="priceFilter" class="form-select">
          <option value="all">All prices</option>
          <option value="0-50">₹0 - ₹50</option>
          <option value="50-200">₹50 - ₹200</option>
          <option value="200-1000">₹200 - ₹1000</option>
        </select>
      </div>
    </div>

    <div id="productsGrid" class="row g-4"></div>
  </main>

  <script>
    async function loadProducts(){
      const res = await fetch('/api/products');
      const products = await res.json();
      window.__products = products;
      renderProducts(products);
    }

    function renderProducts(list){
      const grid = document.getElementById('productsGrid');
      grid.innerHTML = '';
      if(!list.length) return grid.innerHTML = '<div class="p-4 text-muted">No products found</div>';
      list.forEach(p=>{
        const col = document.createElement('div'); col.className = 'col-12 col-sm-6 col-md-4';
        col.innerHTML = `
          <div class="card product-card h-100">
            <img src="${p.image||'/assets/placeholder.png'}" class="card-img-top" style="height:200px;object-fit:cover" />
            <div class="card-body d-flex flex-column">
              <h5 class="card-title">${p.name}</h5>
              <p class="card-text text-muted small">${p.description||''}</p>
              <div class="mt-auto d-flex justify-content-between align-items-center">
                <strong>₹${Number(p.price).toFixed(2)}</strong>
                <button class="btn btn-sm btn-success add-now" data-id="${p._id}">Add</button>
              </div>
            </div>
          </div>`;
        grid.appendChild(col);
      });
      document.querySelectorAll('.add-now').forEach(btn=> btn.addEventListener('click', e=>{
        const id = e.target.dataset.id;
        const cart = JSON.parse(localStorage.getItem('ft_cart')||'[]');
        const entry = cart.find(i=>i.product===id);
        if(entry) entry.qty +=1; else cart.push({product:id, qty:1});
        localStorage.setItem('ft_cart', JSON.stringify(cart));
        alert('Added to cart');
      }));
    }

    function applyFilters(){
      let list = (window.__products||[]).slice();
      const q = document.getElementById('searchInput').value.trim().toLowerCase();
      if(q) list = list.filter(p=> (p.name||'').toLowerCase().includes(q) || (p.description||'').toLowerCase().includes(q));
      const pf = document.getElementById('priceFilter').value;
      if(pf !== 'all'){
        const [min,max] = pf.split('-').map(Number);
        list = list.filter(p=> p.price >= min && p.price <= max);
      }
      const sort = document.getElementById('sortSelect').value;
      if(sort === 'price_asc') list.sort((a,b)=>a.price-b.price);
      else if(sort === 'price_desc') list.sort((a,b)=>b.price-a.price);
      else list.sort((a,b)=> new Date(b.createdAt) - new Date(a.createdAt));
      renderProducts(list);
    }

    document.getElementById('searchInput').addEventListener('input', applyFilters);
    document.getElementById('sortSelect').addEventListener('change', applyFilters);
    document.getElementById('priceFilter').addEventListener('change', applyFilters);

    loadProducts();
  </script>
</body>
</html>